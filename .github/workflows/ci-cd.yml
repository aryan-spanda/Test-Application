# Application Repository CI/CD Workflow - No Automatic Helm Generation
# This workflow manages Helm values manually and calls platform CI/CD for building

name: Build and Deploy Test Application

on:
  push:
    branches: [main, develop, cicd, testing]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - 'RESTRUCTURE.md'
      - 'PLATFORM-REQUIREMENTS.md'
  pull_request:
    branches: [main]

permissions:
  contents: write
  packages: write
  security-events: write

jobs:
  # ===================================================================
  # PHASE 1: READ APP DEVELOPER'S TEST CONFIGURATION
  # ===================================================================
  read-test-config:
    name: Read Platform Test Configuration
    runs-on: ubuntu-latest
    outputs:
      frontend-enabled: ${{ steps.config.outputs.frontend-enabled }}
      backend-enabled: ${{ steps.config.outputs.backend-enabled }}
      frontend-working-dir: ${{ steps.config.outputs.frontend-working-dir }}
      backend-working-dir: ${{ steps.config.outputs.backend-working-dir }}
      frontend-setup-commands: ${{ steps.config.outputs.frontend-setup-commands }}
      backend-setup-commands: ${{ steps.config.outputs.backend-setup-commands }}
      frontend-test-command: ${{ steps.config.outputs.frontend-test-command }}
      backend-test-command: ${{ steps.config.outputs.backend-test-command }}
      app-name: ${{ steps.config.outputs.app-name }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Parse Platform Test Configuration
        id: config
        run: |
          # Install yq for YAML parsing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          # Platform Contract: App developers MUST provide application-test.yml
          if [ ! -f "application-test.yml" ]; then
            echo "‚ùå ERROR: application-test.yml not found!"
            echo "Application developers must provide this file to specify their tests."
            exit 1
          fi
          
          # Read configuration provided by app developer
          echo "frontend-enabled=$(yq '.tests.frontend.enabled' application-test.yml)" >> $GITHUB_OUTPUT
          echo "backend-enabled=$(yq '.tests.backend.enabled' application-test.yml)" >> $GITHUB_OUTPUT
          echo "frontend-working-dir=$(yq '.tests.frontend.working_directory' application-test.yml)" >> $GITHUB_OUTPUT
          echo "backend-working-dir=$(yq '.tests.backend.working_directory' application-test.yml)" >> $GITHUB_OUTPUT
          echo "frontend-setup-commands=$(yq '.tests.frontend.setup_commands | join(" && ")' application-test.yml)" >> $GITHUB_OUTPUT
          echo "backend-setup-commands=$(yq '.tests.backend.setup_commands | join(" && ")' application-test.yml)" >> $GITHUB_OUTPUT
          echo "frontend-test-command=$(yq '.tests.frontend.test_command' application-test.yml)" >> $GITHUB_OUTPUT
          echo "backend-test-command=$(yq '.tests.backend.test_command' application-test.yml)" >> $GITHUB_OUTPUT
          echo "app-name=$(yq '.app.name' application-test.yml)" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Platform test configuration loaded from app developer:"
          cat application-test.yml

  # ===================================================================
  # PHASE 2: EXECUTE APP DEVELOPER'S TESTS (Technology Agnostic)
  # ===================================================================
  test-frontend:
    name: Frontend Tests (App Developer Specified)
    runs-on: ubuntu-latest
    needs: read-test-config
    if: needs.read-test-config.outputs.frontend-enabled == 'true'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      # Platform doesn't care about technology - just runs what app dev specified
      - name: Run App Developer's Frontend Setup Commands
        run: |
          cd ${{ needs.read-test-config.outputs.frontend-working-dir }}
          ${{ needs.read-test-config.outputs.frontend-setup-commands }}
          
      - name: Run App Developer's Frontend Tests
        run: |
          cd ${{ needs.read-test-config.outputs.frontend-working-dir }}
          ${{ needs.read-test-config.outputs.frontend-test-command }}
        env:
          CI: true

  test-backend:
    name: Backend Tests (App Developer Specified)
    runs-on: ubuntu-latest
    needs: read-test-config
    if: needs.read-test-config.outputs.backend-enabled == 'true'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      # Platform doesn't care about technology - just runs what app dev specified
      - name: Run App Developer's Backend Setup Commands
        run: |
          cd ${{ needs.read-test-config.outputs.backend-working-dir }}
          ${{ needs.read-test-config.outputs.backend-setup-commands }}
          
      - name: Run App Developer's Backend Tests
        run: |
          cd ${{ needs.read-test-config.outputs.backend-working-dir }}
          ${{ needs.read-test-config.outputs.backend-test-command }}

  # ===================================================================
  # PHASE 3: BUILD CONTAINER (Platform Responsibility)
  # ===================================================================
  build-and-push:
    name: Build and Push Container
    runs-on: ubuntu-latest
    needs: [read-test-config, test-frontend, test-backend]
    # Platform Rule: Only build if ALL enabled tests pass
    if: always() && (needs.test-frontend.result == 'success' || needs.test-frontend.result == 'skipped') && (needs.test-backend.result == 'success' || needs.test-backend.result == 'skipped') && github.event_name == 'push'
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ===================================================================
  # PHASE 3: UPDATE HELM VALUES (Only after successful build)
  # ===================================================================
  update-helm-values:
    name: Update Helm Values
    runs-on: ubuntu-latest
    needs: [build-and-push]  # Only after successful build
    if: github.event_name == 'push'
    outputs:
      image-tag: ${{ steps.vars.outputs.image-tag }}
    steps:
    - name: Checkout app repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set variables
      id: vars
      run: |
        SHORT_SHA=${GITHUB_SHA::8}
        echo "image-tag=${SHORT_SHA}" >> $GITHUB_OUTPUT

    - name: Update Helm values with new image tag
      run: |
        NEW_TAG="${{ steps.vars.outputs.image-tag }}"
        
        echo "Updating Helm values with image tag: ${NEW_TAG}"
        
        # Update your actual chart path
        CHART_PATH="deploy/helm"
        
        # Update development values
        if [ -f "${CHART_PATH}/values-dev.yaml" ]; then
          sed -i "s|tag: \".*\"|tag: \"${NEW_TAG}\"|g" ${CHART_PATH}/values-dev.yaml
          echo "‚úÖ Updated values-dev.yaml"
        fi
        
        # Update staging values  
        if [ -f "${CHART_PATH}/values-staging.yaml" ]; then
          sed -i "s|tag: \".*\"|tag: \"${NEW_TAG}\"|g" ${CHART_PATH}/values-staging.yaml
          echo "‚úÖ Updated values-staging.yaml"
        fi
        
        # Update production values (only on main branch)
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          if [ -f "${CHART_PATH}/values-prod.yaml" ]; then
            sed -i "s|tag: \".*\"|tag: \"${NEW_TAG}\"|g" ${CHART_PATH}/values-prod.yaml
            echo "‚úÖ Updated values-prod.yaml (main branch)"
          fi
        else
          echo "‚è≠Ô∏è  Skipped values-prod.yaml (not main branch)"
        fi

    - name: Commit updated Helm values
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        if git diff --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        git add deploy/helm/values-*.yaml
        git commit -m "üöÄ Update Helm values to use image tag ${{ steps.vars.outputs.image-tag }}

        Updated by: CI/CD Pipeline
        Commit: ${GITHUB_SHA}
        Branch: ${{ github.ref_name }}"
        
        git push

  # ===================================================================
  # PHASE 4: VALIDATE HELM CHARTS (Platform Quality Gate)
  # ===================================================================
  validate-helm:
    name: Validate Helm Charts
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: Validate Helm charts
      run: |
        helm lint deploy/helm/
        
        # Template the charts to check for syntax errors  
        helm template test-app deploy/helm/ --values deploy/helm/values-dev.yaml > /dev/null || echo "‚ö†Ô∏è  values-dev.yaml not found"
        helm template test-app deploy/helm/ --values deploy/helm/values-staging.yaml > /dev/null || echo "‚ö†Ô∏è  values-staging.yaml not found"
        helm template test-app deploy/helm/ --values deploy/helm/values-production.yaml > /dev/null || echo "‚ö†Ô∏è  values-production.yaml not found"
        
        echo "‚úÖ Helm chart validation completed"
